metadata:
  repository: autonomy/conform
  variables:
    binaryPath: /conform
    gitRepository: github.com/autonomy/conform
    maintainer: Andrew Rynhard <andrew.rynhard@autonomy.io>

policies:
  - type: conventionalCommit
    spec:
      types:
        - "chore"
        - "docs"
        - "perf"
        - "refactor"
        - "style"
        - "test"
      scopes:
        - "ci"
        - "cli"
        - "docker"
        - "fmt"
        - "git"
        - "metadata"
        - "pipeline"
        - "policy"
        - "readme"
        - "renderer"
        - "service"
        - "*"

script:
  template: |
    #!/bin/bash

    set -e

    # Only run if not a PR.
    if [[ "${TRAVIS_PULL_REQUEST}" != "false" ]]; then
        exit 0
    fi

    if [[ "${TRAVIS_BRANCH}" == "master" ]] || [[ ! -z "${TRAVIS_TAG}" ]]; then
        # Check if working tree is clean.
        if [[ "{{ .Git.IsClean }}" != "true" ]]; then
            echo "The working tree is dirty."
            exit 1
        fi

        echo "Pushing image {{ .Docker.Image.Name }}:{{ .Docker.Image.Tag }}"
        docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"
        docker push {{ .Docker.Image.Name }}:{{ .Docker.Image.Tag }}
        docker tag {{ .Docker.Image.Name }}:{{ .Docker.Image.Tag }} {{ .Repository }}:latest
        docker push {{ .Repository }}:latest

        # Check if ref is a tag.
        if [[ "{{ .Git.IsTag }}" != "true" ]]; then
            exit 0
        fi

        # Check if the tag is a prerelease.
        if [[ "{{ .Version.IsPrerelease }}" == "true" ]]; then
            echo "Publishing prerelease {{ .Version.Major }}.{{ .Version.Minor }}.{{ .Version.Patch }}-{{ .Version.Prerelease }}"
            docker tag {{ .Docker.Image.Name }}:{{ .Docker.Image.Tag }} {{ .Repository }}:{{ .Version.Major }}.{{ .Version.Minor }}.{{ .Version.Patch }}-{{ .Version.Prerelease }}
            docker push {{ .Repository }}:{{ .Version.Major }}.{{ .Version.Minor }}.{{ .Version.Patch }}-{{ .Version.Prerelease }}
        else
            echo "Publishing release {{ .Version.Major }}.{{ .Version.Minor }}.{{ .Version.Patch }}"
            docker tag {{ .Docker.Image.Name }}:{{ .Docker.Image.Tag }} {{ .Repository }}:{{ .Version.Major }}.{{ .Version.Minor }}.{{ .Version.Patch }}
            docker push {{ .Repository }}:{{ .Version.Major }}.{{ .Version.Minor }}.{{ .Version.Patch }}
        fi
    fi

pipeline:
  stages:
    - src
    - test
    - build

stages:
  src:
    tasks:
      - src
  test:
    artifacts:
      - source: /src/github.com/autonomy/conform/coverage.txt
        destination: coverage.txt
    tasks:
      - test
  build:
    tasks:
      - binary
      - image

tasks:
  binary:
    template: |
      FROM autonomy/conform:src AS {{ .Docker.CurrentStage }}
      {{ if and .Git.IsClean .Git.IsTag }}
      RUN go build -o {{ index .Variables "binaryPath" }} -ldflags "-s -w -X \"{{ index .Variables "gitRepository" }}/cmd.Tag={{ trimAll "v" .Git.Tag }}\" -X \"{{ index .Variables "gitRepository" }}/cmd.SHA={{ .Git.SHA }}\" -X \"{{ index .Variables "gitRepository" }}/cmd.Built={{ .Built }}\""
      {{ else if .Git.IsClean }}
      RUN go build -o {{ index .Variables "binaryPath" }} -ldflags "-s -w -X \"{{ index .Variables "gitRepository" }}/cmd.SHA={{ .Git.SHA }}\" -X \"{{ index .Variables "gitRepository" }}/cmd.Built={{ .Built }}\""
      {{ else }}
      RUN go build -o {{ index .Variables "binaryPath" }}
      {{ end }}
  test:
    template: |
      FROM autonomy/conform:src AS {{ .Docker.CurrentStage }}
      RUN curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | bash -s -- -b $GOPATH/bin v1.10.1
      RUN chmod +x ./hack/test.sh
      RUN ./hack/test.sh --lint ./hack/golangci-lint.yaml
      RUN ./hack/test.sh --unit
      RUN ./hack/test.sh --coverage
  src:
    template: |
      FROM golang:1.11.1 AS {{ .Docker.CurrentStage }}
      ENV GO111MODULE on
      ENV CGO_ENABLED 0
      WORKDIR /src/{{ index .Variables "gitRepository" }}
      COPY ./ ./
      RUN go mod download
      RUN go mod verify

  image:
    template: |
      FROM alpine:3.8 AS {{ .Docker.CurrentStage }}
      LABEL maintainer="{{ index .Variables "maintainer" }}"
      RUN apk --no-cache add bash
      COPY --from=binary {{ index .Variables "binaryPath" }} /bin
      ENTRYPOINT ["conform"]
